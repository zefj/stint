# Stint Changes Plan

## Overview

This document outlines the planned changes to improve the stint CLI based on real usage feedback.

---

## 1. Enhanced `stint status` - Daily Summary

### Current Behavior
- Shows only currently running timers with elapsed time

### New Behavior
- Show all sessions for today (completed + running)
- Sum up total hours tracked today
- Running timer shown with no end time, included in total

### Implementation

**File: `src/commands/status.ts`**

```typescript
// Pseudocode structure
export async function status() {
  const today = getTodayRange(); // start/end of today in unix timestamps

  // Get all sessions for today (including running ones)
  const todaySessions = getSessionsInRange(today.start, today.end);

  // Group by timer
  const sessionsByTimer = groupBy(todaySessions, 'timer_id');

  // Display each timer's sessions
  for (const [timerId, sessions] of sessionsByTimer) {
    const timer = getTimerById(timerId);
    console.log(timer.name);

    for (const session of sessions) {
      const start = formatTime(session.start);
      const end = session.end ? formatTime(session.end) : '→ now';
      const duration = formatDuration(getSessionDuration(session));
      console.log(`  ${start} - ${end}  (${duration})`);
    }
  }

  // Total including running timer
  const totalSeconds = todaySessions.reduce((sum, s) => sum + getSessionDuration(s), 0);
  console.log(`\nTotal today: ${formatDuration(totalSeconds)}`);
}
```

**Example Output:**
```
Today (21/01/2026):

work
  09:15 - 12:30  (3h 15m)
  14:00 → now    (2h 45m)

music
  13:00 - 13:45  (45m)

Total today: 6h 45m
```

---

## 2. `stint start/stop <timer> [time]` - Retroactive Time Entry

### Current Behavior
- `stint start work` starts timer at current time
- `stint stop work` stops timer at current time

### New Behavior
- `stint start work 09:00` starts timer at 09:00 today
- `stint stop work 12:30` stops timer at 12:30 today
- `stint start work 14:00` starts again at 14:00

### Critical Constraint
**You cannot start a timer before the latest stop event across ALL timers.**

This prevents overlapping/impossible timelines:
- If you stopped `work` at 12:30, you cannot start anything at 12:00
- The latest `end` timestamp is the cutoff for new `start` timestamps
- This maintains chronological integrity

### Implementation

**File: `src/commands/start.ts`**

```typescript
export const startCommand = new Command('start')
  .argument('[timer]', 'timer name')
  .argument('[time]', 'start time (HH:MM) - defaults to now')
  .action(async (timerName?: string, timeArg?: string) => {
    let startTimestamp: number;

    if (timeArg) {
      // Parse HH:MM and combine with today's date
      startTimestamp = parseTimeToday(timeArg);

      // CRITICAL: Validate against latest stop event
      const latestEnd = getLatestEndTimestamp(); // across ALL sessions
      if (latestEnd && startTimestamp < latestEnd) {
        const latestEndFormatted = formatDateTime(latestEnd);
        throw new Error(
          `Cannot start at ${timeArg} - latest session ended at ${latestEndFormatted}. ` +
          `Start time must be after the last stop event.`
        );
      }
    } else {
      startTimestamp = Math.floor(Date.now() / 1000);
    }

    // Rest of start logic...
  });
```

**File: `src/commands/stop.ts`**

```typescript
export const stopCommand = new Command('stop')
  .argument('[timer]', 'timer name')
  .argument('[time]', 'stop time (HH:MM) - defaults to now')
  .action(async (timerName?: string, timeArg?: string) => {
    let stopTimestamp: number;

    if (timeArg) {
      stopTimestamp = parseTimeToday(timeArg);

      // Validate: stop time must be after session start
      const activeSession = getActiveSession(timerId);
      if (stopTimestamp <= activeSession.start) {
        throw new Error(
          `Stop time ${timeArg} is before or equal to start time. ` +
          `Session started at ${formatTime(activeSession.start)}.`
        );
      }
    } else {
      stopTimestamp = Math.floor(Date.now() / 1000);
    }

    // Rest of stop logic...
  });
```

**File: `src/lib/session.ts`** (new function)

```typescript
export function getLatestEndTimestamp(): number | null {
  const db = getDb();
  const result = db.query<{ max_end: number | null }, []>(`
    SELECT MAX(end) as max_end FROM timer_sessions WHERE end IS NOT NULL
  `).get();
  return result?.max_end ?? null;
}
```

**File: `src/lib/date-utils.ts`** (new function)

```typescript
export function parseTimeToday(timeStr: string): number {
  // Parse HH:MM format
  const match = timeStr.match(/^(\d{1,2}):(\d{2})$/);
  if (!match) {
    throw new Error(`Invalid time format: ${timeStr}. Use HH:MM (e.g., 09:30, 14:00)`);
  }

  const hours = parseInt(match[1], 10);
  const minutes = parseInt(match[2], 10);

  if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
    throw new Error(`Invalid time: ${timeStr}. Hours must be 0-23, minutes 0-59.`);
  }

  const now = new Date();
  const target = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes, 0);

  return Math.floor(target.getTime() / 1000);
}
```

**Example Usage:**
```bash
# Morning work session
stint start work 09:00
stint stop work 12:30

# Lunch break (no tracking)

# Afternoon session
stint start work 14:00
stint stop work 17:30

# This would FAIL:
stint start music 13:00  # Error: latest session ended at 17:30
```

---

## 3. Edit/Delete Entries

### New Commands

#### `stint edit <session-id> [--start HH:MM] [--end HH:MM]`

Edit an existing session's start/end times.

**Implementation:**

```typescript
export const editCommand = new Command('edit')
  .argument('<session-id>', 'session ID (shown in stint status)')
  .option('--start <time>', 'new start time (HH:MM)')
  .option('--end <time>', 'new end time (HH:MM)')
  .action(async (sessionId: string, options) => {
    const session = getSessionById(sessionId);
    if (!session) {
      throw new Error(`Session ${sessionId} not found`);
    }

    // Build update
    const updates: Partial<TimerSession> = {};

    if (options.start) {
      updates.start = parseTimeFromSessionDate(session.start, options.start);
    }
    if (options.end) {
      updates.end = parseTimeFromSessionDate(session.start, options.end);
    }

    // Validate chronology
    const newStart = updates.start ?? session.start;
    const newEnd = updates.end ?? session.end;
    if (newEnd && newEnd <= newStart) {
      throw new Error('End time must be after start time');
    }

    updateSession(sessionId, updates);
    console.log(`✓ Updated session ${sessionId}`);
  });
```

#### `stint delete <session-id> [--force]`

Delete a specific session.

**Implementation:**

```typescript
export const deleteCommand = new Command('delete')
  .argument('<session-id>', 'session ID to delete')
  .option('-f, --force', 'skip confirmation')
  .action(async (sessionId: string, options) => {
    const session = getSessionById(sessionId);
    if (!session) {
      throw new Error(`Session ${sessionId} not found`);
    }

    if (!options.force) {
      const timer = getTimerById(session.timerId);
      const confirmed = await confirm({
        message: `Delete session for "${timer.name}" (${formatSessionRange(session)})?`
      });
      if (!confirmed) {
        console.log('Cancelled');
        return;
      }
    }

    deleteSession(sessionId);
    console.log(`✓ Deleted session ${sessionId}`);
  });
```

### Displaying Session IDs

Modify `stint status` to show short session IDs for easy reference:

```
Today (21/01/2026):

work
  [a1b2c3] 09:15 - 12:30  (3h 15m)
  [d4e5f6] 14:00 → now    (2h 45m)

# Then user can run:
stint edit a1b2c3 --end 12:45
stint delete a1b2c3
```

Use first 6 characters of nanoid for display (collision-unlikely for daily sessions).

---

## 4. Merge `stint log` into `stint status`

### Current State
- `stint status` - shows running timers only
- `stint log [range]` - shows session history

### Problem
Duplicated functionality. `stint status` is more intuitive name.

### Solution
- `stint status` becomes the main command (shows today by default)
- `stint status [range]` accepts optional date range argument
- Remove or deprecate `stint log`

**New `stint status` Behavior:**

```bash
stint status              # Today's sessions (default)
stint status yesterday    # Yesterday's sessions
stint status week         # Last 7 days
stint status 2026-01-15   # Specific date
stint status 2026-01-01..2026-01-15  # Date range
```

**Implementation:**

```typescript
export const statusCommand = new Command('status')
  .argument('[range]', 'date range (today, yesterday, week, YYYY-MM-DD, or YYYY-MM-DD..YYYY-MM-DD)')
  .description('Show time tracking status and history')
  .action(async (range?: string) => {
    const { start, end } = parseDateRange(range ?? 'today');

    const sessions = getSessionsInRange(start, end);
    const sessionsByDay = groupByDay(sessions);

    for (const [date, daySessions] of sessionsByDay) {
      console.log(`\n${formatDate(date)}:`);

      const byTimer = groupBy(daySessions, 'timer_id');
      for (const [timerId, timerSessions] of byTimer) {
        const timer = getTimerById(timerId);
        console.log(`\n${timer.name}`);

        for (const session of timerSessions) {
          const id = session.id.slice(0, 6);
          const start = formatTime(session.start);
          const end = session.end ? formatTime(session.end) : '→ now';
          const duration = formatDuration(getSessionDuration(session));
          console.log(`  [${id}] ${start} - ${end}  (${duration})`);
        }
      }

      const dayTotal = daySessions.reduce((sum, s) => sum + getSessionDuration(s), 0);
      console.log(`\nTotal: ${formatDuration(dayTotal)}`);
    }
  });
```

---

## 5. Hide "No new migrations to apply" Message

### Problem
Annoying message every time CLI runs when no migrations needed.

### Solution
Only log migration messages when something actually happens.

**File: `src/lib/db.ts`**

```typescript
export function runMigrations(options: { silent?: boolean } = {}) {
  const db = getDb();
  const applied = getAppliedMigrations(db);
  const pending = getPendingMigrations(applied);

  if (pending.length === 0) {
    // REMOVE THIS: console.log('No new migrations to apply');
    // Just silently return
    return;
  }

  // Only log when actually applying migrations
  for (const migration of pending) {
    if (!options.silent) {
      console.log(`Applying migration: ${migration.name}`);
    }
    applyMigration(db, migration);
  }
}
```

**Alternative: Add verbose flag**

```typescript
// In db initialization, default to silent
initDb({ verbose: false });

// Or environment variable
if (process.env.STINT_DEBUG) {
  console.log('No new migrations to apply');
}
```

---

## 6. European Date Formatting

### Problem
American date format (MM/DD/YYYY) is confusing and illogical.

### Solution
1. **Primary**: Use system locale settings
2. **Fallback**: ISO 8601 (YYYY-MM-DD) - unambiguous
3. **Never**: American MM/DD/YYYY format

### Implementation

**File: `src/lib/format.ts`**

```typescript
// Detect system locale
function getSystemLocale(): string {
  // Try environment variables first
  const locale = process.env.LC_TIME || process.env.LC_ALL || process.env.LANG;
  if (locale) {
    // Extract locale code (e.g., "en_GB.UTF-8" -> "en-GB")
    const match = locale.match(/^([a-z]{2})_([A-Z]{2})/);
    if (match) {
      return `${match[1]}-${match[2]}`;
    }
  }
  // Default to ISO-like format via en-GB (DD/MM/YYYY)
  return 'en-GB';
}

const SYSTEM_LOCALE = getSystemLocale();

export function formatDate(timestamp: number): string {
  const date = new Date(timestamp * 1000);

  // Use Intl.DateTimeFormat with system locale
  return new Intl.DateTimeFormat(SYSTEM_LOCALE, {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
  }).format(date);
}

export function formatDateTime(timestamp: number): string {
  const date = new Date(timestamp * 1000);

  return new Intl.DateTimeFormat(SYSTEM_LOCALE, {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    hour12: false,
  }).format(date);
}

export function formatDateLong(timestamp: number): string {
  const date = new Date(timestamp * 1000);

  // e.g., "Tuesday, 21 January 2026"
  return new Intl.DateTimeFormat(SYSTEM_LOCALE, {
    weekday: 'long',
    day: 'numeric',
    month: 'long',
    year: 'numeric',
  }).format(date);
}
```

**Expected Results by Locale:**

| Locale | formatDate() | formatDateTime() |
|--------|-------------|------------------|
| en-GB | 21/01/2026 | 21/01/2026, 14:30 |
| de-DE | 21.01.2026 | 21.01.2026, 14:30 |
| fr-FR | 21/01/2026 | 21/01/2026 14:30 |
| ja-JP | 2026/01/21 | 2026/01/21 14:30 |
| en-US | **BLOCKED** | **BLOCKED** |

**Explicitly Block en-US:**

```typescript
function getSystemLocale(): string {
  const rawLocale = process.env.LC_TIME || process.env.LC_ALL || process.env.LANG || '';

  // Parse locale
  const match = rawLocale.match(/^([a-z]{2})_([A-Z]{2})/);
  if (match) {
    const locale = `${match[1]}-${match[2]}`;

    // NEVER use American date format
    if (locale === 'en-US') {
      return 'en-GB'; // Force sensible format
    }
    return locale;
  }

  // Default to en-GB (DD/MM/YYYY)
  return 'en-GB';
}
```

---

## Implementation Order

### Phase 1: Quick Wins
1. [ ] Hide migration message (5 min)
2. [ ] European date formatting (15 min)

### Phase 2: Status Overhaul
3. [ ] Merge `stint log` into `stint status`
4. [ ] Add daily total to status output
5. [ ] Show session IDs in output
6. [ ] Include running timer in total calculation

### Phase 3: Retroactive Entry
7. [ ] Add `[time]` argument to `stint start`
8. [ ] Add `[time]` argument to `stint stop`
9. [ ] Implement chronology validation (latest end cutoff)
10. [ ] Add `parseTimeToday()` utility

### Phase 4: Edit/Delete
11. [ ] Add `stint edit <session-id>` command
12. [ ] Add `stint delete <session-id>` command
13. [ ] Add confirmation prompts

---

## Testing Checklist

- [ ] `stint status` shows today's sessions with totals
- [ ] `stint status yesterday` shows yesterday's sessions
- [ ] `stint start work 09:00` starts at specified time
- [ ] `stint start work 08:00` fails if last session ended at 12:00
- [ ] `stint stop work 17:30` stops at specified time
- [ ] `stint edit <id> --end 18:00` updates session
- [ ] `stint delete <id>` removes session with confirmation
- [ ] Dates display as DD/MM/YYYY (or system locale)
- [ ] No "No new migrations" message on startup
